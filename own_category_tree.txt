# own_category_tree v0.0.1
# Creates a hierarchical list of categories
# Dmitry Shovchko
# http://github.com/dshovchko/own_category_tree

# ......................................................................
# This is a plugin for Textpattern - http://textpattern.com/
# To install: textpattern > admin > plugins
# Paste the following text into the 'Install plugin' box:
# ......................................................................

YToxMDp7czo3OiJ2ZXJzaW9uIjtzOjU6IjAuMC4xIjtzOjY6ImF1dGhvciI7czoxNToiRG1p
dHJ5IFNob3ZjaGtvIjtzOjEwOiJhdXRob3JfdXJpIjtzOjQ1OiJodHRwOi8vZ2l0aHViLmNv
bS9kc2hvdmNoa28vb3duX2NhdGVnb3J5X3RyZWUiO3M6MTE6ImRlc2NyaXB0aW9uIjtzOjQx
OiJDcmVhdGVzIGEgaGllcmFyY2hpY2FsIGxpc3Qgb2YgY2F0ZWdvcmllcyI7czo0OiJ0eXBl
IjtzOjE6IjEiO3M6MTU6ImFsbG93X2h0bWxfaGVscCI7czoxOiIxIjtzOjQ6Im5hbWUiO3M6
MTc6Im93bl9jYXRlZ29yeV90cmVlIjtzOjQ6ImhlbHAiO3M6Njc6Igo8IS0tICoqKiBCRUdJ
TiBQTFVHSU4gQ1NTICoqKiAtLT4KPCEtLSAqKiogRU5EIFBMVUdJTiBDU1MgKioqIC0tPgoi
O3M6NDoiY29kZSI7czozNDE4OiIKZnVuY3Rpb24gb3duX2NhdGVnb3J5X3RyZWUoJGF0dHMp
IHsKCWdsb2JhbCAkcHJldGV4dDsKCglleHRyYWN0KGxBdHRzKGFycmF5KAoJCSdzdGFydCcJ
CT0+ICdyb290JywKCQknc2VjdGlvbicJPT4gMCwKCQkndHlwZScJCT0+ICdhcnRpY2xlJywK
CQknY3NzaWQnCQk9PiAnJywKCQknb25jbGFzcycJPT4gJycsCgkJJ3dyYXB0YWcnCT0+ICd1
bCcsCgkJJ2JyZWFrJwkJPT4gJ2xpJywKCQknbG9jYWxlJwk9PiAnJywKCSksJGF0dHMpKTsK
CglpZiAoJHN0YXJ0ID09ICcqJykgJHN0YXJ0ID0gJHByZXRleHRbJ2MnXSA/ICRwcmV0ZXh0
WydjJ10gOiAncm9vdCc7CglpZiAoJHN0YXJ0ID09ICcqcycpICRzdGFydCA9ICRHTE9CQUxT
WydzJ107CglpZiAoJHNlY3Rpb24gPT0gJyonKSAkc2VjdGlvbiA9ICRHTE9CQUxTWydzJ107
CglpZiAoJHdyYXB0YWcgPT0gJyAnKSAkd3JhcHRhZyA9ICcnOwoJaWYgKCRicmVhayA9PSAn
ICcpICRicmVhayA9ICcnOwoKCSR2YXJzID0gY29tcGFjdCgnc3RhcnQnLCdzZWN0aW9uJywn
dHlwZScsJ2Nzc2lkJywnb25jbGFzcycsJ3dyYXB0YWcnLCdicmVhaycpOwoKCWlmICgkbG9j
YWxlKSB7CgkJc2V0bG9jYWxlKExDX0FMTCwgJGxvY2FsZSk7Cgl9CgoJJGwgPSBvd25fY2F0
ZWdvcnlfdHJlZV9nZXRfbGlzdCgkdHlwZSk7CgkkciA9IG93bl9jYXRlZ29yeV90cmVlX21h
a2VfdHJlZSgkbCwgJHZhcnMpOwoKCXJldHVybiAkcjsKfQoKZnVuY3Rpb24gb3duX2NhdGVn
b3J5X3RyZWVfbWFrZV90cmVlKCRsaXN0LCAkdmFycykgewoJZ2xvYmFsICRwcmV0ZXh0OwoK
CSRjYXRlZ29yaWVzID0gYXJyYXkoKTsKCWlmIChpbnR2YWwoJHByZXRleHRbJ2lkJ10pID09
IDApIHsKCQkkY2F0ZWdvcmllc1tdID0gJHByZXRleHRbJ2MnXTsKCX0gZWxzZSB7CgkJZ2xv
YmFsICR0aGlzYXJ0aWNsZTsKCgkJJGNhdGVnb3JpZXNbXSA9ICR0aGlzYXJ0aWNsZVsnY2F0
ZWdvcnkxJ107CgkJJGNhdGVnb3JpZXNbXSA9ICR0aGlzYXJ0aWNsZVsnY2F0ZWdvcnkyJ107
Cgl9CgoJJHQgPSBvd25fY2F0ZWdvcnlfdHJlZV9nZXRfYnJhbmNoKCRsaXN0LCAkdmFyc1sn
c3RhcnQnXSk7CgkkbCA9IDA7CgoJcmV0dXJuIG93bl9jYXRlZ29yeV90cmVlX21ha2Vfc3Vi
dHJlZSgkdCwgJGNhdGVnb3JpZXMsICRsLCAkdmFycyk7Cn0KCmZ1bmN0aW9uIG93bl9jYXRl
Z29yeV90cmVlX2dldF9icmFuY2goJGxpc3QsICRmcm9tKSB7CgkkciA9ICcnOwoKCSRhID0g
YXJyYXkoKTsKCWZvcmVhY2goJGxpc3QgYXMgJHYpIHsKCQlpZiAoJHZbJ3BhcmVudCddID09
ICRmcm9tKSB7CgkJCSRhWyR2WyduYW1lJ11dID0gJHZbJ3RpdGxlJ107CgkJfQoJfQoKCWFz
b3J0KCRhLCBTT1JUX0xPQ0FMRV9TVFJJTkcpOwoKCSRzID0gYXJyYXkoKTsKCWZvcmVhY2go
JGEgYXMgJG5hbWU9PiR0aXRsZSkgewoJCWZvcmVhY2goJGxpc3QgYXMgJHYpIHsKCQkJaWYg
KCR2WyduYW1lJ10gPT0gJG5hbWUpIHsKCQkJCSR2WydjaGlsZHJlbiddID0gb3duX2NhdGVn
b3J5X3RyZWVfZ2V0X2JyYW5jaCgkbGlzdCwgJG5hbWUpOwoJCQkJJHNbXSA9ICR2OwoJCQl9
CgkJfQoJfQoKCXJldHVybiAkczsKfQoKZnVuY3Rpb24gb3duX2NhdGVnb3J5X3RyZWVfY2hl
Y2tfc3VidHJlZSgkbGlzdCwgJGNhdGVnb3JpZXMpIHsKCgkkbCA9IDA7Cglmb3JlYWNoKCRs
aXN0IGFzICR2KSB7CgkJaWYgKGluX2FycmF5KCR2WyduYW1lJ10sICRjYXRlZ29yaWVzKSkg
ewoJCQkkbCsrOwoJCX0KCQkkbCArPSBvd25fY2F0ZWdvcnlfdHJlZV9jaGVja19zdWJ0cmVl
KCR2WydjaGlsZHJlbiddLCAkY2F0ZWdvcmllcyk7Cgl9CgoJcmV0dXJuICRsOwp9CgpmdW5j
dGlvbiBvd25fY2F0ZWdvcnlfdHJlZV9tYWtlX3N1YnRyZWUoJGxpc3QsICRjYXRlZ29yaWVz
LCAkbCwgJHZhcnMpIHsKCgkkciA9ICcnOwoJZm9yZWFjaCgkbGlzdCBhcyAkdikgewoJCSRy
YyA9ICcnOwoJCWlmIChvd25fY2F0ZWdvcnlfdHJlZV9jaGVja19zdWJ0cmVlKCR2WydjaGls
ZHJlbiddLCAkY2F0ZWdvcmllcykgPiAwIHx8IGluX2FycmF5KCR2WyduYW1lJ10sJGNhdGVn
b3JpZXMpKSB7CgkJCSRyYyA9IG93bl9jYXRlZ29yeV90cmVlX21ha2Vfc3VidHJlZSgkdlsn
Y2hpbGRyZW4nXSwgJGNhdGVnb3JpZXMsICRsKzEsICR2YXJzKTsKCQl9CgkJJGNsYXNzID0g
JHZhcnNbJ29uY2xhc3MnXSAmJiBpbl9hcnJheSgkdlsnbmFtZSddLCRjYXRlZ29yaWVzKSA/
ICR2YXJzWydvbmNsYXNzJ10gOiAnJzsKCQkkbGluayA9IG93bl9jYXRlZ29yeV90cmVlX2xp
bmsoJHZbJ25hbWUnXSwgJHZhcnNbJ3NlY3Rpb24nXSwgJHZbJ3RpdGxlJ10pOwoJCSRicmVh
ayA9ICR2YXJzWydicmVhayddOwoJCWlmICgkYnJlYWsgPT0gJ2JyJyB8fCAkYnJlYWsgPT0g
J2hyJykgewoJCQkkciAuPSBvd25fY2F0ZWdvcnlfdHJlZV90YWIoJGwpLmpvaW4oZG9UYWco
JycsICRicmVhayksIGFycmF5KCRsaW5rLCAkcmMpKTsKCQl9IGVsc2UgewoJCQkkciAuPSBv
d25fY2F0ZWdvcnlfdHJlZV90YWIoJGwpLmRvV3JhcChhcnJheSgkbGluaywgJHJjKSwgJGJy
ZWFrLCAnJywgJGNsYXNzKTsKCQl9Cgl9CgoJJGF0dHMgPSAoJHZhcnNbJ2Nzc2lkJ10gJiYg
JGwgPT0gMCk/JyBpZD0iJy4kdmFyc1snY3NzaWQnXS4nIic6Jyc7CgoJcmV0dXJuIG93bl9j
YXRlZ29yeV90cmVlX3RhYigkbCkuZG9XcmFwKGFycmF5KCRyKSwgJHZhcnNbJ3dyYXB0YWcn
XSwgJycsICcnLCAnJywgJGF0dHMpOwp9CgpmdW5jdGlvbiBvd25fY2F0ZWdvcnlfdHJlZV9n
ZXRfbGlzdCgkdHlwZSkgewoJZ2xvYmFsICRvd25fY2F0ZWdvcnlfdHJlZV9jYWNoZTsKCglp
ZiAoIWlzc2V0KCRvd25fY2F0ZWdvcnlfdHJlZV9jYWNoZSkpewoJCSRvd25fY2F0ZWdvcnlf
dHJlZV9jYWNoZSA9IGFycmF5KCk7Cgl9CgoJaWYgKCFpc3NldCgkb3duX2NhdGVnb3J5X3Ry
ZWVfY2FjaGVbJHR5cGVdKSkgewoJCSRyID0gc2FmZV9yb3dzKCJuYW1lLHBhcmVudCx0aXRs
ZSIsICJ0eHBfY2F0ZWdvcnkiLCAidHlwZT0nJHR5cGUnIG9yZGVyIGJ5IGlkIGFzYyIpOwoJ
CSRvd25fY2F0ZWdvcnlfdHJlZV9jYWNoZVskdHlwZV0gPSAkcjsKCX0gZWxzZSB7CgkJJHIg
PSAkb3duX2NhdGVnb3J5X3RyZWVfY2FjaGVbJHR5cGVdOwoJfQoKCXJldHVybiAkcjsKfQoK
ZnVuY3Rpb24gb3duX2NhdGVnb3J5X3RyZWVfbGluaygkY2F0ZWdvcnksICRzZWN0aW9uLCAk
dGl0bGUpCnsKCSRjYXRfbGluayA9IHBhZ2VsaW5rdXJsKGFycmF5KCdjJz0+JGNhdGVnb3J5
LCAncyc9PiRzZWN0aW9uKSk7CgoJcmV0dXJuIHRhZyhodG1sc3BlY2lhbGNoYXJzKCR0aXRs
ZSksICdhJywgJyBocmVmPSInLiRjYXRfbGluay4nIiB0aXRsZT0iJy5odG1sc3BlY2lhbGNo
YXJzKCR0aXRsZSkuJyInKTsKfQoKZnVuY3Rpb24gb3duX2NhdGVnb3J5X3RyZWVfdGFiKCRs
KSB7CglyZXR1cm4gc3RyX3JlcGVhdCgiXHQiLCAkbCk7Cn0KIjtzOjM6Im1kNSI7czozMjoi
NzBjMDhhZDE3YjBiMGJlMGNkMzVlYmJkYTUwMjg5ZDciO30=
